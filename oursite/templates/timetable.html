{% load static %}
<!DOCTYPE html>
<html lang="ja">




<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>時間割|Mentaiko University</title>

  <!-- Bootstrap core CSS -->
  <link href="{% static 'vendor/bootstrap/css/bootstrap.css' %}" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="{% static 'css/heroic-features.css' %}" rel="stylesheet">
  <link href="{% static 'css/timetable.css' %}" rel="stylesheet">

  <!-- Including Intro.js -->
  <link href="https://unpkg.com/intro.js/minified/introjs.min.css" rel="stylesheet">

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#">Mentaiko University</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active">
            <a class="nav-link" href="/test">Home
              <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Contact</a>
          </li>
          <li class="nav-item">
            <a class="nav-link white" href="#"><span class="login-button" data-title="ログイン/サインアップ">博多 明太子</span></a>
          </li>
        </ul>
      </div>
    </div>
  </nav>


  <!-- Page Content -->
  <div class="container">

    <!-- Jumbotron Header -->
    <header class="jumbotron my-4 white">
      <h1 class="display-3">時間割</h1>
      <p class="lead">必修科目・・赤，選択科目・・黄，人文科目・・緑....</p>
      <a href="#" id="btn-tutorial" class="btn btn-primary btn-lg" href="javascript:void(0);" onclick="introJs().start();">How to use?</a>
    </header>

    <!-- 時間割テーブル本体-->
    <table class="ehr-timetable" id="ehr-timetable" data-step="1" data-intro="ここではあなたの時間割を登録できます。" data-title="チュートリアル">
      <tr>
      <th class="ehr-timetable-hiddencell"></th>
        <td class="ehr-timetable-daycell">月</td>
        <td class="ehr-timetable-daycell">火</td>
        <td class="ehr-timetable-daycell">水</td>
        <td class="ehr-timetable-daycell">木</td>
        <td class="ehr-timetable-daycell">金</td>
        <td class="ehr-timetable-daycell">土</td>
      </tr>
    </table>

    <!-- ポップアップ -->
    <div class="modal fade" id="ehr-Modal" tabindex="-1">
    	<div class="modal-dialog">
    		<div class="modal-content">
    			<div class="modal-header">
    				<h4 class="modal-title">N曜日 M限目</h4>
    			</div>
          <div class="cp_ipselect cp_sl04">
            <select name="new-subject" id="new-subject"></select><br>
          </div>
    			<div class="modal-body">
            <div id="ehr-subject-note">
              <div>
                メモ
              </div>
    				  <textarea class="subject-note" id="subject-note" cols="40" rows="5" wrap="soft"></textarea>
            </div>
          </div>
    			<div class="modal-footer">
            <button type="button" class="btn btn-delete" onclick="modalDeleteButtonClick()">削除</button>
    				<button type="button" class="btn btn-cancel" data-dismiss="modal">キャンセル</button>
    				<button type="button" class="btn btn-submit" onclick="modalButtonClick()">保存</button>
    			</div>
    		</div>
    	</div>
    </div>



  </div>
  <!-- /.container -->

  <!-- Footer -->
  <footer class="py-5 bg-dark">
    <div class="container">
      <p class="m-0 text-center text-white">Copyright &copy; Team-I Mentaiko 2021</p>
    </div>
    <!-- /.container -->
  </footer>

  <!-- Bootstrap core JavaScript -->
  <script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
  <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script type="text/javascript" src="https://unpkg.com/intro.js/minified/intro.min.js"></script>



  <script>

    //選択中の時間割
    var day = -1
    var timed = -1
    var tutorial = 0

    //testユーザの時間割
    var t = '{"Mon":{"1":{"subject":"キャリア教育基礎","note":"","flag":"1"},"2":{"subject":"","note":"","flag":"0"},"3":{"subject":"","note":"","flag":"0"},"4":{"subject":"化学概論","note":"","flag":"1"},"5":{"subject":"","note":"","flag":"0"},"6":{"subject":"","note":"","flag":"0"},"7":{"subject":"","note":"","flag":"0"}},' +
     ' "Tue":{"1":{"subject":"プログラミング基礎","note":"","flag":"1"},"2":{"subject":"プログラミング基礎","note":"","flag":"1"},"3":{"subject":"","note":"","flag":"0"},"4":{"subject":"","note":"","flag":"0"},"5":{"subject":"","note":"","flag":"0"},"6":{"subject":"","note":"","flag":"0"},"7":{"subject":"","note":"","flag":"0"}},' +
      ' "Wed":{"1":{"subject":"","note":"","flag":"0"},"2":{"subject":"線形代数学","note":"","flag":"1"},"3":{"subject":"微分積分学","note":"","flag":"1"},"4":{"subject":"","note":"","flag":"0"},"5":{"subject":"","note":"","flag":"0"},"6":{"subject":"","note":"","flag":"0"},"7":{"subject":"","note":"","flag":"0"}},' +
       ' "Thu":{"1":{"subject":"基礎科学実験","note":"","flag":"1"},"2":{"subject":"基礎科学実験","note":"","flag":"1"},"3":{"subject":"","note":"","flag":"0"},"4":{"subject":"","note":"","flag":"0"},"5":{"subject":"","note":"","flag":"0"},"6":{"subject":"","note":"","flag":"0"},"7":{"subject":"","note":"","flag":"0"}},' +
        ' "Fri":{"1":{"subject":"","note":"","flag":"0"},"2":{"subject":"物理学概論","note":"","flag":"1"},"3":{"subject":"","note":"","flag":"0"},"4":{"subject":"数学演習第一","note":"","flag":"1"},"5":{"subject":"","note":"","flag":"0"},"6":{"subject":"","note":"","flag":"0"},"7":{"subject":"","note":"","flag":"0"}},' +
         ' "Sat":{"1":{"subject":"","note":"","flag":"0"},"2":{"subject":"","note":"","flag":"0"},"3":{"subject":"","note":"","flag":"0"},"4":{"subject":"","note":"","flag":"0"},"5":{"subject":"","note":"","flag":"0"},"6":{"subject":"","note":"","flag":"0"},"7":{"subject":"","note":"","flag":"0"}}}';

    //科目群
    var s1 = ["キャリア教育基礎","化学概論","プログラミング基礎","線形代数学","微分積分学","基礎科学実験","物理学概論","数学演習第一"];
    var s2 = ["数理統計学","体育","物理学演習","心理学A","経済学A","歴史A","線形代数学","政治A","倫理学A","独語第一","露語第一","仏語第一","中国語第一"];
    //時間割作成
    var userTimetable = getUserTimetable();

    var timeTable = document.getElementById("ehr-timetable");
    for (var i = 0; i < 7; i++) {
        var tr = document.createElement('tr');
        for (var j = 0; j < 7; j++) {
            if(j === 0) {
                var th = document.createElement('th');
                th.textContent = i + 1 + " 限";
                tr.appendChild(th);
            } else {
                var td = document.createElement('td');
                //ここにデータベースから持ってきた値突っ込む{科目名,必修選択,メモ,講義教室,zoomURL}
                var d = Object.keys(userTimetable);
                console.log(userTimetable[d[j-1]][i+1]['subject']);
                td.textContent = userTimetable[d[j-1]][i+1]['subject'];
                td.id = "ehr-timetable-" + (i + 1) + "-" + j
                if(userTimetable[d[j-1]][i+1]['flag'] === "1"){
                  td.style.backgroundColor = "#e9967a";
                }
                //月曜一限にtutorialJS
                if (i === 0 && j === 1){
                  td.setAttribute("data-step","2");
                  td.setAttribute("data-intro","必修科目はこの色で表示されます。これらは自動で登録されています。");
                  td.setAttribute("data-title","チュートリアル");
                }
                //水曜一限にtutorialJS
                if (i === 0 && j === 3){
                  td.setAttribute("data-step","3");
                  td.setAttribute("data-intro","空いているコマを選択し、選択科目を登録していきましょう。");
                  td.setAttribute("data-title","チュートリアル");
                }
                tr.appendChild(td);
                td.addEventListener("click", {day: j, timed:i+1, handleEvent: onCellClick});
            }
        }
        timeTable.appendChild(tr);
    }

    //セルクリック
    function onCellClick(e){
      //
      initselectSubject();

      var days = ["月","火","水","木","金","土"];
      day = Number(this.day-1);
      timed = this.timed
      var modal = $('#ehr-Modal');
      modal.find('.modal-title').text(days[day] + "曜日 " + timed + " 時限目")

      //モーダル作成
      var subjects = [
        [["数理統計学","キャリア教育基礎"],["数理統計学"],["体育","物理学演習"],["化学概論"],[""],[""],[""]],
        [["プログラミング基礎"],["プログラミング基礎"],[""],[""],[""],[""],[""]],
        [["心理学A","経済学A","歴史A"],["線形代数学"],["微分積分学"],["政治A","倫理学A"],[""],[""],[""]],
        [["基礎科学実験"],["基礎科学実験"],["体育"],["体育"],[""],[""],[""]],
        [["独語第一","露語第一","仏語第一","中国語第一"],["物理学概論"],["体育","数学演習第一"],[""],[""],[""],[""]],
        [[""],["数理統計学"],["体育"],[""],[""],[""],[""]]]
      var selectSubject = document.getElementById('new-subject');
      var slectedSubject = document.getElementById("ehr-timetable-" + timed + "-" + (day+1));
      document.createElement('option')
      for(var i = 0; i < subjects[day][timed-1].length; i++){
        if(subjects[day][timed-1][i] !== ""){
          var option = document.createElement('option');
          option.setAttribute('value', subjects[day][timed-1][i]);
          option.innerHTML = subjects[day][timed-1][i];
          option.id = "select-option"
          if (slectedSubject.textContent === subjects[day][timed-1][i]){
            option.selected = true
          }
          selectSubject.appendChild(option);
        }
      };
      var subjectNote = document.getElementById('subject-note');
      var d = Object.keys(userTimetable);
      if (userTimetable[d[day]][timed]['note'] === ""){
        subjectNote.value = "";
      } else {
        subjectNote.value = userTimetable[d[day]][timed]['note'];
        //console.log(userTimetable[d[day]][timed]['note']);
      }
      //console.log(slectedSubject.textContent);
      modal.modal();
    }


    //モーダルの「保存」ボタンクリック時の動作
    function modalButtonClick(){
      try {
        var days = ["Mon","Tue","Wed","Thu","Fri","Sat"];
        var newSubject = document.getElementById("new-subject").value;
        var newNote = document.getElementById("subject-note").value;
        userTimetable[days[day]][timed]["subject"] = newSubject;
        userTimetable[days[day]][timed]["note"] = newNote;
        if (newSubject !== ""){
          var td = document.getElementById("ehr-timetable-" + timed + "-" + (day+1));
          td.textContent = newSubject;
          if (s1.indexOf(newSubject) === -1){
            td.style.backgroundColor = "#eeeeee";
          } else {
            td.style.backgroundColor = "#e9967a";
          }
        }
        $('#ehr-Modal').modal('hide');
      } catch (error){
        console.log(error)
        $('#ehr-Modal').modal('hide');
      }
      initselectSubject();
      console.log(userTimetable);
    }

    //selectタグの子要素初期化
    function initselectSubject(){
      var selectSubject = document.getElementById('new-subject');
      while (selectSubject.firstChild) {
        selectSubject.removeChild(selectSubject.firstChild);
      }
    }



    //モーダルの削除ボタン押下時の処理
    function modalDeleteButtonClick(){
      var days = ["Mon","Tue","Wed","Thu","Fri","Sat"];
      var td = document.getElementById("ehr-timetable-" + timed + "-" + (day+1));
      td.textContent = "";
      td.style.backgroundColor = "#eeeeee";
      userTimetable[days[day]][timed]["subject"] = "";
      userTimetable[days[day]][timed]["note"] = "";
      $('#ehr-Modal').modal('hide');
    }

    //ユーザの時間割取得
    function getUserTimetable(){
      return JSON.parse(t)
    }


    //チュートリアルイベント
    document.getElementById('btn-tutorial').addEventListener('click', function(event) {
      tutorial = 1;
    });




    //user_timetable(id text, name text, Mon text, Tue text, Wed text, Thu text, Fri text, Sat text)

//{'' : '','' : '','' : '','' : '','' : '','' : '','' : '','' : ''}


  </script>




</body>

</html>
